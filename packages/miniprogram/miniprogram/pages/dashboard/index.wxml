<view class="dashboard-page">
  <nav-bar title="{{state.gathering.name}}" />

  <view class="content" wx:if="{{!loading && state}}">
    <!-- èšä¼šä¿¡æ¯åŒº -->
    <view class="info-card">
      <view class="info-header">
        <status-tag status="{{state.gathering.status}}" type="gathering" />
        <view class="share-btn" bindtap="onShareAppMessage">
          <text>ğŸ“¤</text>
        </view>
      </view>

      <view class="info-row">
        <text class="info-label">ç›®æ ‡æ—¶é—´</text>
        <text class="info-value">{{formatTime(state.gathering.target_time)}}</text>
      </view>

      <view class="info-row">
        <text class="info-label">é‚€è¯·ç </text>
        <view class="code-box" bindtap="onCopyCode">
          <text class="code-text">{{state.gathering.code}}</text>
          <text class="copy-icon">ğŸ“‹</text>
        </view>
      </view>
    </view>

    <!-- å‚ä¸è€…åˆ—è¡¨ -->
    <view class="section">
      <view class="section-title">å‚ä¸è€… ({{state.participants.length}})</view>
      <view class="participants">
        <view class="participant-item" wx:for="{{state.participants}}" wx:key="id">
          <view class="participant-avatar">{{item.nickname.charAt(0)}}</view>
          <view class="participant-info">
            <text class="participant-name">{{item.nickname}}</text>
            <status-tag status="{{item.status}}" type="participant" />
          </view>
        </view>
      </view>
    </view>

    <!-- é¤å…æ¨èåˆ—è¡¨ -->
    <view class="section" wx:if="{{state.restaurants.length > 0}}">
      <view class="section-title">é¤å…æ¨è</view>
      <restaurant-card
        wx:for="{{state.restaurants}}"
        wx:key="id"
        restaurant="{{item}}"
        rank="{{index + 1}}"
        showVoteBtn="{{state.gathering.status === 'waiting'}}"
        bindvote="onVoteRestaurant"
      />
    </view>

    <!-- æŠ•ç¥¨åŒº -->
    <view class="vote-card" wx:if="{{state.activeVote}}">
      <view class="vote-header">
        <text class="vote-title">ğŸ—³ï¸ æŠ•ç¥¨è¿›è¡Œä¸­</text>
      </view>
      <view class="vote-restaurant">
        <text class="vote-restaurant-name">{{state.restaurants[state.activeVote.restaurant_index].name}}</text>
      </view>
      <view class="vote-progress">
        <view class="vote-stats">
          <text class="vote-agree">ğŸ‘ {{state.activeVote.agree_count}}</text>
          <text class="vote-disagree">ğŸ‘ {{state.activeVote.disagree_count}}</text>
        </view>
        <view class="vote-bar">
          <view class="vote-bar-fill" style="width: {{state.activeVote.agree_count / state.activeVote.total_voters * 100}}%"></view>
        </view>
      </view>
      <view class="vote-actions" wx:if="{{!state.activeVote.has_voted}}">
        <button class="vote-btn vote-agree" bindtap="onCastVote" data-agree="{{true}}">
          åŒæ„
        </button>
        <button class="vote-btn vote-disagree" bindtap="onCastVote" data-agree="{{false}}">
          åå¯¹
        </button>
      </view>
      <view class="vote-voted" wx:else>
        <text>âœ… ä½ å·²æŠ•ç¥¨</text>
      </view>
    </view>

    <!-- åœ°å›¾åŒº -->
    <view class="section">
      <view class="section-title">ä½ç½®åœ°å›¾</view>
      <map
        class="map"
        latitude="{{mapCenterLat}}"
        longitude="{{mapCenterLng}}"
        markers="{{mapMarkers}}"
        show-location
      />
    </view>

    <!-- æ¶ˆæ¯æµ -->
    <view class="section">
      <view class="section-title">æ¶ˆæ¯åŠ¨æ€</view>
      <scroll-view class="messages" scroll-y scroll-into-view="msg-{{state.messages.length - 1}}">
        <message-item
          wx:for="{{state.messages}}"
          wx:key="id"
          id="msg-{{index}}"
          message="{{item}}"
        />
      </scroll-view>
    </view>

    <!-- æ“ä½œæ  -->
    <view class="action-bar">
      <button
        wx:if="{{state.gathering.status === 'waiting'}}"
        class="action-btn primary"
        bindtap="onRecommend"
      >
        è·å–æ¨è
      </button>
      <button
        wx:elif="{{state.gathering.status === 'confirmed'}}"
        class="action-btn primary"
        bindtap="onDepart"
      >
        æˆ‘å·²å‡ºå‘
      </button>
      <button
        wx:elif="{{state.gathering.status === 'active'}}"
        class="action-btn primary"
        bindtap="onArrive"
      >
        æˆ‘å·²åˆ°è¾¾
      </button>
    </view>
  </view>

  <view class="loading-view" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>
