<view class="dashboard-page">
  <nav-bar title="{{gatheringTitle}}" />

  <view class="content" wx:if="{{!loading && state}}">
    <view class="info-card">
      <view class="info-header">
        <status-tag status="{{gatheringStatus}}" type="gathering" />
        <button class="share-btn" open-type="share">分享</button>
      </view>

      <view class="info-row">
        <text class="info-label">目标时间</text>
        <text class="info-value">{{targetTimeText}}</text>
      </view>

      <view class="info-row">
        <text class="info-label">邀请码</text>
        <view class="code-box" bindtap="onCopyCode">
          <text class="code-text">{{state.gathering.code}}</text>
          <text class="copy-icon">复制</text>
        </view>
      </view>
    </view>

    <view class="section">
      <view class="section-title">参与者 ({{state.participants.length}})</view>
      <view class="participants">
        <view class="participant-item" wx:for="{{participantsView}}" wx:key="id">
          <view class="participant-avatar">{{item.avatarText}}</view>
          <view class="participant-info">
            <text class="participant-name">{{item.nickname}}</text>
            <status-tag status="{{item.status}}" type="participant" />
          </view>
        </view>
      </view>
    </view>

    <view class="section" wx:if="{{state.gathering.status === 'waiting'}}">
      <view class="card-block">
        <view class="block-title">等待阶段</view>
        <view class="block-sub">等待参与者加入后由发起人开始提名</view>
        <button
          wx:if="{{isCreator}}"
          class="action-btn primary"
          bindtap="onStartNominating"
          disabled="{{actionLoading || state.participants.length < 2}}"
        >
          开始提名
        </button>
      </view>
    </view>

    <view class="section" wx:if="{{state.gathering.status === 'nominating'}}">
      <view class="card-block">
        <view class="block-title">提名阶段</view>
        <view class="block-sub">你已提名 {{myNominationCount}} / 2</view>

        <view class="form-line">
          <input
            class="form-input"
            placeholder="搜索餐厅关键词（如：火锅）"
            bindinput="onSearchKeywordInput"
            value="{{searchKeyword}}"
          />
          <button class="mini-btn" bindtap="onSearchRestaurants" disabled="{{actionLoading}}">搜索</button>
        </view>

        <view class="list" wx:if="{{searchResults.length > 0}}">
          <view class="list-item" wx:for="{{searchResults}}" wx:key="amap_id">
            <view class="list-main">
              <view class="list-title">{{item.name}}</view>
              <view class="list-sub">{{item.address}}</view>
            </view>
            <button
              class="mini-btn"
              data-index="{{index}}"
              bindtap="onNominateSearch"
              disabled="{{actionLoading || myNominationCount >= 2}}"
            >提名</button>
          </view>
        </view>

        <view class="form-line">
          <input
            class="form-input"
            placeholder="口味关键词（逗号分隔，如：火锅,川菜）"
            bindinput="onAiTastesInput"
            value="{{aiTasteInput}}"
          />
          <button class="mini-btn" bindtap="onAiSuggest" disabled="{{actionLoading}}">AI推荐</button>
        </view>

        <view class="list" wx:if="{{aiSuggestions.length > 0}}">
          <view class="list-item" wx:for="{{aiSuggestions}}" wx:key="amap_id">
            <view class="list-main">
              <view class="list-title">{{item.name}}</view>
              <view class="list-sub">{{item.reason}}</view>
            </view>
            <button
              class="mini-btn"
              data-index="{{index}}"
              bindtap="onNominateSuggestion"
              disabled="{{actionLoading || myNominationCount >= 2}}"
            >提名</button>
          </view>
        </view>

        <view class="sub-title">全部提名（{{state.nominations.length}}）</view>
        <view class="list" wx:if="{{state.nominations.length > 0}}">
          <view class="list-item" wx:for="{{state.nominations}}" wx:key="id">
            <view class="list-main">
              <view class="list-title">{{item.name}}</view>
              <view class="list-sub">{{item.source === 'ai' ? 'AI推荐' : '手动搜索'}} · 评分 {{item.score}}</view>
            </view>
            <button
              wx:if="{{me && item.nominated_by === me.id}}"
              class="mini-btn ghost"
              data-id="{{item.id}}"
              bindtap="onWithdrawNomination"
              disabled="{{actionLoading}}"
            >撤回</button>
          </view>
        </view>

        <button
          wx:if="{{isCreator}}"
          class="action-btn primary"
          bindtap="onStartVoting"
          disabled="{{actionLoading || !canStartVoting}}"
        >
          开始投票
        </button>
      </view>
    </view>

    <view class="section" wx:if="{{state.gathering.status === 'voting'}}">
      <view class="card-block">
        <view class="block-title">投票阶段</view>
        <view class="block-sub" wx:if="{{state.activeVote}}">
          已投 {{state.activeVote.total_voted}} / {{state.activeVote.total_participants}}
        </view>

        <view class="list" wx:if="{{state.nominations.length > 0}}">
          <view class="list-item" wx:for="{{state.nominations}}" wx:key="id">
            <view class="list-main">
              <view class="list-title">{{item.name}}</view>
              <view class="list-sub">票数：{{voteCounts[item.id] || 0}}</view>
            </view>
            <button
              class="mini-btn"
              data-nomination-id="{{item.id}}"
              bindtap="onCastVote"
              disabled="{{actionLoading || !state.activeVote || state.activeVote.has_voted}}"
            >投这家</button>
          </view>
        </view>

        <view class="block-sub" wx:if="{{state.activeVote && state.activeVote.has_voted}}">你已投票，等待结果</view>
      </view>
    </view>

    <view class="section" wx:if="{{state.gathering.status === 'confirmed' || state.gathering.status === 'departing' || state.gathering.status === 'completed'}}">
      <view class="card-block">
        <view class="block-title">确认与出发</view>
        <view class="block-sub" wx:if="{{confirmedNomination}}">已确认餐厅：{{confirmedNomination.name}}</view>
        <view class="block-sub" wx:else>尚未识别到已确认餐厅</view>

        <view class="button-row" wx:if="{{state.gathering.status !== 'completed'}}">
          <button
            class="action-btn primary"
            bindtap="onDepart"
            disabled="{{actionLoading || !me || me.status !== 'joined'}}"
          >
            我已出发
          </button>
          <button
            class="action-btn secondary"
            bindtap="onArrive"
            disabled="{{actionLoading || !me || me.status !== 'departed'}}"
          >
            我已到达
          </button>
        </view>
      </view>
    </view>

    <view class="section">
      <view class="section-title">位置地图</view>
      <map
        class="map"
        latitude="{{mapCenterLat}}"
        longitude="{{mapCenterLng}}"
        markers="{{mapMarkers}}"
        show-location
      />
    </view>

    <view class="section">
      <view class="section-title">消息动态</view>
      <scroll-view class="messages" scroll-y scroll-into-view="msg-{{state.messages.length - 1}}">
        <message-item
          wx:for="{{state.messages}}"
          wx:key="id"
          id="msg-{{index}}"
          message="{{item}}"
        />
      </scroll-view>
    </view>
  </view>

  <view class="loading-view" wx:if="{{loading}}">
    <text>加载中...</text>
  </view>
</view>
