# Phase 4: 微信小程序

## 目标

开发微信小程序端，实现与 Web 端功能对等的用户体验，充分利用小程序的原生能力（分享、订阅消息、位置服务等）。

## 前置条件

- ✅ Phase 2 完成：后端 API 服务可用
- ✅ Phase 3 完成：Web 端已实现，可参考交互逻辑
- ✅ 微信小程序开发者账号已注册
- ✅ 小程序 AppID 已获取

## 任务列表

### 4.1 项目搭建与配置 (0.5天)

**目标**: 初始化小程序项目并配置开发环境

**任务**:
- 创建小程序项目（原生或 Taro/uni-app）
- 配置 TypeScript 支持
- 配置 Tailwind CSS（小程序适配版）或原生样式
- 配置 API 请求封装
- 配置状态管理（MobX 或 Pinia）
- 配置环境变量
- 创建基础目录结构
- 配置小程序权限（位置、相机、相册等）
- 配置分包加载

**目录结构**:
```
apps/miniprogram/
├── pages/              # 页面
│   ├── index/          # 首页
│   ├── dashboard/      # 仪表盘
│   ├── my/             # 我的
│   └── login/          # 登录
├── components/         # 组件
├── services/           # API 服务
├── stores/             # 状态管理
├── utils/              # 工具函数
├── styles/             # 全局样式
└── app.json            # 小程序配置
```

**验证标准**:
- [ ] 项目成功编译，模拟器运行正常
- [ ] TypeScript 类型检查通过
- [ ] API 请求拦截器配置完成
- [ ] 样式系统正常工作
- [ ] 分包配置正确

---

### 4.2 登录与首页 (1天)

**目标**: 实现微信登录和首页功能

**任务**:
- **登录页**:
  - 实现微信授权登录
  - 实现手机号绑定（使用 button open-type="getPhoneNumber"）
  - 实现用户信息获取
  - 实现 token 存储
  - 实现自动登录
- **首页**:
  - 实现顶部导航栏
  - 实现快速创建聚会入口
  - 实现聚会列表（进行中、已完成）
  - 实现聚会卡片组件
  - 实现下拉刷新
  - 实现上拉加载更多
  - 实现空状态提示

**页面路由**:
- `/pages/login/index`
- `/pages/index/index`

**验证标准**:
- [ ] 微信授权登录成功
- [ ] 手机号绑定成功
- [ ] Token 正确存储
- [ ] 首页聚会列表正确展示
- [ ] 下拉刷新和上拉加载正常
- [ ] 点击卡片跳转到详情页

---

### 4.3 聚会仪表盘 (1.5天)

**目标**: 实现聚会详情和核心交互功能

**任务**:
- 实现聚会信息展示
- 实现参与者列表和状态
- 实现地点推荐功能
  - 调用微信位置 API 获取当前位置
  - 调用后端推荐接口
  - 展示推荐地点列表
- 实现地点投票功能
  - 多选投票 UI
  - 投票提交和取消
  - 投票统计展示
- 实现地图展示
  - 使用 `<map>` 组件展示地点
  - 支持地点标记和点击
- 实现催促功能
- 实现实时轮询更新
- 实现聚会状态流转
- 实现分享功能（分享到好友/群聊）

**页面路由**: `/pages/dashboard/index`

**验证标准**:
- [ ] 聚会信息完整展示
- [ ] 位置获取成功
- [ ] 地点推荐功能正常
- [ ] 投票功能正常，统计准确
- [ ] 地图正确显示地点位置
- [ ] 催促功能正常
- [ ] 轮询更新不影响用户操作
- [ ] 分享功能正常，分享卡片美观

---

### 4.4 我的聚会与个人中心 (1天)

**目标**: 实现个人聚会管理和用户设置

**任务**:
- **我的聚会页**:
  - 实现聚会分类（我创建的、我参与的）
  - 实现聚会筛选（进行中、已完成）
  - 实现聚会搜索
  - 实现聚会编辑
  - 实现聚会删除
- **个人中心页**:
  - 实现用户信息展示
  - 实现头像和昵称编辑
  - 实现通知中心
  - 实现设置页面（主题、通知偏好）
  - 实现关于页面
  - 实现退出登录

**页面路由**:
- `/pages/my-gatherings/index`
- `/pages/my/index`

**验证标准**:
- [ ] 聚会分类和筛选正常
- [ ] 搜索功能准确
- [ ] 编辑功能正常保存
- [ ] 删除功能有二次确认
- [ ] 用户信息更新成功
- [ ] 通知列表正确展示
- [ ] 退出登录清除本地数据

---

### 4.5 分享与订阅消息 (1天)

**目标**: 实现小程序特色功能，提升用户留存

**任务**:
- **分享功能**:
  - 实现聚会分享到好友
  - 实现聚会分享到群聊
  - 自定义分享卡片（标题、图片、路径）
  - 实现分享回调统计
- **订阅消息**:
  - 配置订阅消息模板
  - 实现订阅消息授权
  - 实现聚会状态变更通知
  - 实现投票提醒通知
  - 实现催促通知
- **其他功能**:
  - 实现客服消息（可选）
  - 实现意见反馈
  - 实现小程序码生成（后端）

**验证标准**:
- [ ] 分享功能正常，卡片美观
- [ ] 分享链接可正确打开聚会详情
- [ ] 订阅消息授权成功
- [ ] 通知正确发送到用户
- [ ] 小程序码生成成功

---

### 4.6 性能优化与体验打磨 (1天)

**目标**: 优化小程序性能和用户体验

**任务**:
- **性能优化**:
  - 优化首屏加载速度
  - 实现图片懒加载
  - 优化长列表性能（虚拟列表）
  - 优化 setData 调用
  - 实现分包预加载
  - 优化网络请求（合并、缓存）
- **体验打磨**:
  - 实现骨架屏加载
  - 优化加载动画
  - 优化错误提示
  - 实现触觉反馈（wx.vibrateShort）
  - 优化页面转场动画
  - 实现无网络提示
- **测试**:
  - 真机测试（iOS + Android）
  - 兼容性测试
  - 性能测试

**验证标准**:
- [ ] 首屏加载时间 < 2s
- [ ] 页面切换流畅，无卡顿
- [ ] 长列表滚动流畅
- [ ] 体验评分 > 90 分
- [ ] 真机测试无明显问题
- [ ] 兼容主流机型

---

## 总验证标准

- [ ] 所有功能与 Web 端对等
- [ ] 小程序审核规范符合要求
- [ ] 用户体验流畅自然
- [ ] 分享和订阅消息正常
- [ ] 性能指标达标
- [ ] 真机测试通过
- [ ] 无明显 Bug
- [ ] 代码质量良好

## 预估时间

**总计**: 5-6 天

- 4.1 项目搭建: 0.5天
- 4.2 登录+首页: 1天
- 4.3 仪表盘: 1.5天
- 4.4 我的聚会+个人中心: 1天
- 4.5 分享+订阅消息: 1天
- 4.6 性能优化: 1天

## 技术栈

- **框架**: 微信小程序原生 / Taro / uni-app
- **语言**: TypeScript
- **样式**: WXSS / Tailwind CSS (小程序版)
- **状态管理**: MobX / Pinia
- **地图**: 微信地图组件 + 高德地图 API
- **测试**: 小程序自动化测试工具

## 注意事项

1. 遵守微信小程序审核规范
2. 合理使用小程序原生能力
3. 注意用户隐私保护（位置、手机号等）
4. 分享功能不得诱导分享
5. 订阅消息需用户主动授权
6. 优化包体积，避免超过 2MB 主包限制
7. 适配不同屏幕尺寸（iPhone、Android）
8. 处理网络异常和弱网环境
9. 实现优雅降级（API 不可用时）
10. 定期更新小程序版本

## 小程序特色功能

- ✅ 微信授权登录
- ✅ 手机号快速绑定
- ✅ 位置服务（获取当前位置）
- ✅ 地图展示（原生 map 组件）
- ✅ 分享到好友/群聊
- ✅ 订阅消息通知
- ✅ 小程序码生成
- ✅ 触觉反馈
- ⭕ 客服消息（可选）
- ⭕ 直播功能（可选）
